<!DOCTYPE html>
    {% extends 'base.html' %}
    {% block content %}
{%load static%}
            <style>
               #map {
                height: 600px;
                width: 100%;
               }
               #setz {
             position: absolute;
             z-index: 1;
            }
            #opac{
              margin: 10px;
              background-color: #ffffff;
              opacity: 0.6;
              filter: alpha(opacity=60); /* For IE8 and earlier */
            }
            </style>

            <div id="setz" class="row" style="width: 100%; padding: 0; margin: 0;">
              <div class="col-xs-1 col-md-1 col-sm-1">
                
              </div>
             <div class="col-xs-10 col-md-10 col-sm-10"  id="opac" style="border-color: #45606D; border-style: solid; border-radius: 5px;   border-color:#14384B" >
                  <div  style="height: 4%;" >
                        <img style="text-align: left; width: 5%; margin:5% 5% 5% 5%;" src="{%static 'Urgent/Client/2C-Home/2.png'%}">
                        
                  </div>
                  <div >
                        <input type="text" name="argarn" style=" width: 80%; height: 100%; margin: 5% 5% 5% 5%; display: inline-block; float: right;">
                      
                  </div>

            <!-- </div> -->
             </div>
               <div class="col-xs-1 col-md-1 col-sm-1">
                 
               </div>

            </div>
            
            
          <div id = "map" ></div>

          <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
          <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
          <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>
          <script>
          var map, infoWindow;
          var locations = new Array()
            var data,len
            var successHandler = function(position) {
            alert(position.coords.latitude);
            alert(position.coords.longitude);
            };
            var errorHandler = function (errorObj) {
            alert(errorObj.code + ": " + errorObj.message);
            alert("something wrong take this lat " + 26.0546106 );
            alert("something wrong take this lng " +-98.3939791);
            };
            function initMap() {
              //init map
              map = new google.maps.Map(document.getElementById('map'), {
                center: {lat: -34.397, lng: 150.644},
                zoom: 14
              });
              infoWindow = new google.maps.InfoWindow({
                content: '<IMG BORDER="0" ALIGN="Left" SRC="http://cmtcarsupermarket.co.uk/wp-content/uploads/2016/09/12-Month-Breakdown.png">'
              });
              // get current location
              if (navigator.geolocation) {
                 navigator.geolocation.getCurrentPosition(function(position) {
                      var pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                      };
                      infoWindow.setPosition(pos);
                      infoWindow.setContent("You here")
                      infoWindow.open(map);
                      map.setCenter(pos);
                    }, function() {
                        handleLocationError(true, infoWindow, map.getCenter());
                      });
                } else {
                  // Browser doesn't support Geolocation
                  handleLocationError(false, infoWindow, map.getCenter());
                }
                //marker
                var marker, i;
                infoCradle = new google.maps.InfoWindow();
                $.ajax({
                      url: '/get_garage',
                      async:false,
                      complete: function(data, err) {
                      data = data.responseJSON;
                      len = Object.keys(data).length
                      for(var i = 0 ; i< len ; i++) {
                        //console.log(data[i].fields);
                        var cut = data[i].fields.locations.split(",")
                        var lat,lon
                        lat = cut[0]
                        lon = cut[1]
                        var locaion =[data[i].fields.owner_name, parseFloat(lat), parseFloat(lon), i]
                        locations.push(locaion)
                      }
                      for (i = 0; i < locations.length; i++) {

                          marker = new google.maps.Marker({position: new google.maps.LatLng(locations[i][1], locations[i][2]),
                          map: map
                        });
                        google.maps.event.addListener(marker, 'click', (function(marker, i) {
                          return function() {

                            infoCradle.setContent(
                          "<div style=\"width: 80%; \">"+
                          "<div style=\"width: 39%; text-align:center;    float:left;\">"+
                            "<img style=\"width: 50%;  margin: 12% 0 12% 0;\" src='https://www.mx7.com/i/1bc/4oKxKp.png'>"+
                                                    "</div>"+
                                                    "<div style=\"width: 40%; display: inline-block\">"+
                                                        "<h2 style=\"font-size:100%\"; >name : "+locations[i][0]+"</h2>"+
                                                    "</div>"+"</div>"+"<button onclick=\"myFunction("+i+")\">Click me</button>")




                            infoCradle.open(map, marker);
                          }
                        })(marker, i));
                      }
                    }
                  });

            }
            function handleLocationError(browserHasGeolocation, infoWindow, pos) {
              posFix = {lat: 14.065574699999999, lng: 100.6057261};
              //infoWindow.setPosition(posFix);
              infoWindow.setContent(browserHasGeolocation ?
                                    'Error: The Geolocation service failed.' :
                                    'Error: Your browser doesn\'t support geolocation.');
              infoWindow.setContent("You here")
              infoWindow.open(map);
              map.setCenter(posFix);
              infoWindow.setPosition(posFix);
              infoWindow.setContent("You here")

            }

            function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie != '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = jQuery.trim(cookies[i]);
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) == (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            var csrftoken = getCookie('csrftoken');
            function csrfSafeMethod(method) {
                // these HTTP methods do not require CSRF protection
                return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
            }
            $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
            });

            function myFunction(i) {
                  console.log(locations[i][0]);
                  var mechanic = { "mechanic":locations[i][0]};

            $.ajax({
                type: "POST",
                url: "/select_mechanic",
                data: JSON.stringify(mechanic),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function(data){
                  document.location.href = "/wait"
                  ;},
                failure: function(errMsg) {
                }
              });
            }
            </script>
            <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
            <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyABtz7sfkMygVwWaTmKt474Lio37dou6c0&callback=initMap">
            </script>


    {% endblock %}

